!function(n,l){"object"==typeof exports&&"undefined"!=typeof module?l(exports):"function"==typeof define&&define.amd?define(["exports"],l):l((n=n||self).S={})}(this,function(n){"use strict";function l(n,l){null===d&&console.warn("computations created without a root or parent will never be disposed");var u=b(n,l,!1,!1),t=u.node,i=u.value;return null===t?function(){return i}:function(){return t.current()}}var u={time:function(){return a.time}},t=function(){function n(n){this.value=n,this.pending=e,this.log=null}var l=n.prototype;return l.current=function(){return null!==w&&function(n){null===n.log&&(n.log=new r);g(n.log)}(this),this.value},l.next=function(n){if(null!==v)if(this.pending!==e){if(n!==this.pending)throw new Error("conflicting changes: "+n+" !== "+this.pending)}else this.pending=n,a.changes.add(this);else null!==this.log?(this.pending=n,a.changes.add(this),x()):this.value=n;return n},l.clock=function(){return u},n}(),i=function(){function n(){this.fn=null,this.value=void 0,this.age=-1,this.state=f,this.source1=null,this.source1slot=0,this.sources=null,this.sourceslots=null,this.log=null,this.owned=null,this.cleanups=null}var l=n.prototype;return l.current=function(){if(null!==w){if(this.age===a.time){if(this.state===s)throw new Error("circular dependency");M(this)}!function(n){null===n.log&&(n.log=new r);g(n.log)}(this)}return this.value},l.clock=function(){return u},n}(),r=function(){this.node1=null,this.node1slot=0,this.nodes=null,this.nodeslots=null},o=function(){function n(){this.items=[],this.count=0}var l=n.prototype;return l.reset=function(){this.count=0},l.add=function(n){this.items[this.count++]=n},l.run=function(n){for(var l=this.items,u=0;u<this.count;u++)n(l[u]),l[u]=null;this.count=0},n}(),e={},f=0,c=1,s=2,h=new i,a=new function(){this.time=0,this.changes=new o,this.updates=new o,this.disposes=new o},v=null,w=null,d=null,y=null,p={node:null,value:void 0};function b(n,l,u,t){var i=m(),r=d,o=w,e=null===v;d=i,w=t?null:i,l=e?function(n,l){v=a,a.changes.reset(),a.updates.reset();try{return n(l)}finally{d=w=v=null}}(n,l):n(l),d=r,w=o;var f=E(i,n,l,u);return e&&function(n,l){if(a.changes.count>0||a.updates.count>0){a.time++;try{j(a)}finally{v=null,d=n,w=l}}}(r,o),p.node=f?null:i,p.value=l,p}function m(){var n=y;return null===n?n=new i:y=null,n}function E(n,l,u,t){var i,r=t||null===d||d===h?null:d,o=null===n.source1&&(null===n.owned&&null===n.cleanups||null!==r);if(o){if(y=n,null!==r){if(null!==n.owned){if(null===r.owned)r.owned=n.owned;else for(i=0;i<n.owned.length;i++)r.owned.push(n.owned[i]);n.owned=null}if(null!==n.cleanups){if(null===r.cleanups)r.cleanups=n.cleanups;else for(i=0;i<n.cleanups.length;i++)r.cleanups.push(n.cleanups[i]);n.cleanups=null}}}else n.fn=l,n.value=u,n.age=a.time,null!==r&&(null===r.owned?r.owned=[n]:r.owned.push(n));return o}function g(n){var l,u=w,t=null===u.source1?-1:null===u.sources?0:u.sources.length;null===n.node1?(n.node1=u,n.node1slot=t,l=-1):null===n.nodes?(n.nodes=[u],n.nodeslots=[t],l=0):(l=n.nodes.length,n.nodes.push(u),n.nodeslots.push(t)),null===u.source1?(u.source1=n,u.source1slot=l):null===u.sources?(u.sources=[n],u.sourceslots=[l]):(u.sources.push(n),u.sourceslots.push(l))}function x(){var n=d;a.updates.reset(),a.time++;try{j(a)}finally{v=w=null,d=n}}function j(n){var l=v,u=0;for(v=n,n.disposes.reset();0!==n.changes.count||0!==n.updates.count||0!==n.disposes.count;)if(u>0&&n.time++,n.changes.run(_),n.updates.run(M),n.disposes.run(q),u++>1e5)throw new Error("Runaway clock detected");v=l}function _(n){n.value=n.pending,n.pending=e,n.log&&k(n.log)}function k(n){var l=n.node1,u=n.nodes;if(null!==l&&A(l),null!==u)for(var t=0,i=u.length;t<i;t++)A(u[t])}function A(n){var l=a.time;n.age<l&&(n.age=l,n.state=c,a.updates.add(n),null!==n.owned&&function n(l){for(var u=0;u<l.length;u++){var t=l[u];t.age=a.time,t.state=f,null!==t.owned&&n(t.owned)}}(n.owned),null!==n.log&&k(n.log))}function M(n){if(n.state===c){var l=d,u=w;d=w=n,n.state=s,O(n,!1),n.value=n.fn(n.value),n.state=f,d=l,w=u}}function O(n,l){var u,t,i=n.source1,r=n.sources,o=n.sourceslots,e=n.cleanups,f=n.owned;if(null!==e){for(u=0;u<e.length;u++)e[u](l);n.cleanups=null}if(null!==f){for(u=0;u<f.length;u++)q(f[u]);n.owned=null}if(null!==i&&(R(i,n.source1slot),n.source1=null),null!==r)for(u=0,t=r.length;u<t;u++)R(r.pop(),o.pop())}function R(n,l){var u,t,i=n.nodes,r=n.nodeslots;-1===l?n.node1=null:(u=i.pop(),t=r.pop(),l!==i.length&&(i[l]=u,r[l]=t,-1===t?u.source1slot=l:u.sourceslots[t]=l))}function q(n){n.fn=null,n.log=null,O(n,!0)}n.cleanup=function(n){null===d?console.warn("cleanups created without a root or parent will never be run"):null===d.cleanups?d.cleanups=[n]:d.cleanups.push(n)},n.data=function(n){var l=new t(n);return function(n){return 0===arguments.length?l.current():l.next(n)}},n.default=l,n.disposeNode=function(n){null!==v?a.disposes.add(n):q(n)},n.effect=function(n,l){b(n,l,!1,!1)},n.freeze=function(n){var l=void 0;if(null!==v)l=n();else{(v=a).changes.reset();try{l=n(),x()}finally{v=null}}return l},n.isFrozen=function(){return null!==v},n.isListening=function(){return null!==w},n.makeComputationNode=b,n.makeDataNode=function(n){return new t(n)},n.on=function(n,u,t,i){var r;return Array.isArray(n)&&(r=n,n=function(){for(var n=0;n<r.length;n++)r[n]()}),i=!!i,l(function(l){var t=w;return n(),i?i=!1:(w=null,l=u(l),w=t),l},t)},n.root=function(n){var l,u=d,t=0===n.length?null:function(){null===i||(null!==v?a.disposes.add(i):q(i))},i=null===t?h:m();d=i;try{l=null===t?n():n(t)}finally{d=u}return null!==t&&E(i,null,void 0,!0)&&(i=null),l},n.sample=function(n){var l,u=w;return w=null,l=n(),w=u,l},n.value=function(n,l){var u=new t(n),i=-1;return function(t){if(0===arguments.length)return u.current();if(!(l?l(n,t):n===t)){var r=a.time;if(i===r)throw new Error("conflicting values: "+t+" is not the same as "+n);i=r,n=t,u.next(t)}return t}},Object.defineProperty(n,"l",{value:!0})});
