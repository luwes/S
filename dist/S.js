!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(n=n||self).S=e()}(this,function(){"use strict";var n=function(n,e){null===g&&console.warn("computations created without a root or parent will never be disposed");var t=y(n,e,!1,!1),l=t.node,u=t.value;return null===l?function(){return u}:function(){return l.current()}};Object.defineProperty(n,"default",{value:n}),n.root=function(n){var e,t=g,l=0===n.length?null:function(){null===u||(null!==h?d.disposes.add(u):F(u))},u=null===l?f:m();g=u;try{e=null===l?n():n(l)}finally{g=t}return null!==l&&k(u,null,void 0,!0)&&(u=null),e},n.on=function(e,t,l,u){var o;return Array.isArray(e)&&(o=e,e=function(){for(var n=0;n<o.length;n++)o[n]()}),u=!!u,n(s,l);function s(n){var l=p;return e(),u?u=!1:(p=null,n=t(n),p=l),n}},n.effect=function(n,e){y(n,e,!1,!1)},n.data=function(n){var e=new l(n);return function(n){return 0===arguments.length?e.current():e.next(n)}},n.value=function(n,e){var t=new l(n),u=-1;return function(l){if(0===arguments.length)return t.current();if(!(e?e(n,l):n===l)){var o=d.time;if(u===o)throw new Error("conflicting values: "+l+" is not the same as "+n);u=o,n=l,t.next(l)}return l}},n.freeze=function(n){var e=void 0;if(null!==h)e=n();else{(h=d).changes.reset();try{e=n(),b()}finally{h=null}}return e},n.sample=function(n){var e,t=p;return p=null,e=n(),p=t,e},n.cleanup=function(n){null===g?console.warn("cleanups created without a root or parent will never be run"):null===g.cleanups?g.cleanups=[n]:g.cleanups.push(n)},n.makeDataNode=function(n){return new l(n)},n.makeComputationNode=y,n.disposeNode=function(n){null!==h?d.disposes.add(n):F(n)},n.isFrozen=function(){return null!==h},n.isListening=function(){return null!==p};var e=function(){return function(){this.time=0,this.changes=new s,this.updates=new s,this.disposes=new s}}(),t={time:function(){return d.time}},l=function(){function n(n){this.value=n,this.pending=r,this.log=null}return n.prototype.current=function(){return null!==p&&function(n){null===n.log&&(n.log=new o);x(n.log)}(this),this.value},n.prototype.next=function(n){if(null!==h)if(this.pending!==r){if(n!==this.pending)throw new Error("conflicting changes: "+n+" !== "+this.pending)}else this.pending=n,d.changes.add(this);else null!==this.log?(this.pending=n,d.changes.add(this),b()):this.value=n;return n},n.prototype.clock=function(){return t},n}(),u=function(){function n(){this.fn=null,this.value=void 0,this.age=-1,this.state=i,this.source1=null,this.source1slot=0,this.sources=null,this.sourceslots=null,this.log=null,this.owned=null,this.cleanups=null}return n.prototype.current=function(){if(null!==p){if(this.age===d.time){if(this.state===a)throw new Error("circular dependency");A(this)}!function(n){null===n.log&&(n.log=new o);x(n.log)}(this)}return this.value},n.prototype.clock=function(){return t},n}(),o=function(){return function(){this.node1=null,this.node1slot=0,this.nodes=null,this.nodeslots=null}}(),s=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var e=this.items,t=0;t<this.count;t++)n(e[t]),e[t]=null;this.count=0},n}(),r={},i=0,c=1,a=2,f=new u,d=new e,h=null,p=null,g=null,v=null,w={node:null,value:void 0};function y(n,e,t,l){var u=m(),o=g,s=p,r=null===h;g=u,p=l?null:u,e=r?function(n,e){h=d,d.changes.reset(),d.updates.reset();try{return n(e)}finally{g=p=h=null}}(n,e):n(e),g=o,p=s;var i=k(u,n,e,t);return r&&function(n,e){if(d.changes.count>0||d.updates.count>0){d.time++;try{E(d)}finally{h=null,g=n,p=e}}}(o,s),w.node=i?null:u,w.value=e,w}function m(){var n=v;return null===n?n=new u:v=null,n}function k(n,e,t,l){var u,o=l||null===g||g===f?null:g,s=null===n.source1&&(null===n.owned&&null===n.cleanups||null!==o);if(s){if(v=n,null!==o){if(null!==n.owned){if(null===o.owned)o.owned=n.owned;else for(u=0;u<n.owned.length;u++)o.owned.push(n.owned[u]);n.owned=null}if(null!==n.cleanups){if(null===o.cleanups)o.cleanups=n.cleanups;else for(u=0;u<n.cleanups.length;u++)o.cleanups.push(n.cleanups[u]);n.cleanups=null}}}else n.fn=e,n.value=t,n.age=d.time,null!==o&&(null===o.owned?o.owned=[n]:o.owned.push(n));return s}function x(n){var e,t=p,l=null===t.source1?-1:null===t.sources?0:t.sources.length;null===n.node1?(n.node1=t,n.node1slot=l,e=-1):null===n.nodes?(n.nodes=[t],n.nodeslots=[l],e=0):(e=n.nodes.length,n.nodes.push(t),n.nodeslots.push(l)),null===t.source1?(t.source1=n,t.source1slot=e):null===t.sources?(t.sources=[n],t.sourceslots=[e]):(t.sources.push(n),t.sourceslots.push(e))}function b(){var n=g;d.updates.reset(),d.time++;try{E(d)}finally{h=p=null,g=n}}function E(n){var e=h,t=0;for(h=n,n.disposes.reset();0!==n.changes.count||0!==n.updates.count||0!==n.disposes.count;)if(t>0&&n.time++,n.changes.run(N),n.updates.run(A),n.disposes.run(F),t++>1e5)throw new Error("Runaway clock detected");h=e}function N(n){n.value=n.pending,n.pending=r,n.log&&j(n.log)}function j(n){var e=n.node1,t=n.nodes;if(null!==e&&z(e),null!==t)for(var l=0,u=t.length;l<u;l++)z(t[l])}function z(n){var e=d.time;n.age<e&&(n.age=e,n.state=c,d.updates.add(n),null!==n.owned&&function n(e){for(var t=0;t<e.length;t++){var l=e[t];l.age=d.time,l.state=i,null!==l.owned&&n(l.owned)}}(n.owned),null!==n.log&&j(n.log))}function A(n){if(n.state===c){var e=g,t=p;g=p=n,n.state=a,C(n,!1),n.value=n.fn(n.value),n.state=i,g=e,p=t}}function C(n,e){var t,l,u=n.source1,o=n.sources,s=n.sourceslots,r=n.cleanups,i=n.owned;if(null!==r){for(t=0;t<r.length;t++)r[t](e);n.cleanups=null}if(null!==i){for(t=0;t<i.length;t++)F(i[t]);n.owned=null}if(null!==u&&(D(u,n.source1slot),n.source1=null),null!==o)for(t=0,l=o.length;t<l;t++)D(o.pop(),s.pop())}function D(n,e){var t,l,u=n.nodes,o=n.nodeslots;-1===e?n.node1=null:(t=u.pop(),l=o.pop(),e!==u.length&&(u[e]=t,o[e]=l,-1===l?t.source1slot=e:t.sourceslots[l]=e))}function F(n){n.fn=null,n.log=null,C(n,!0)}return n});
