!function(n,l){"object"==typeof exports&&"undefined"!=typeof module?l(exports):"function"==typeof define&&define.amd?define(["exports"],l):l((n=n||self).l={})}(this,function(n){"use strict";function l(n,l){null===d&&console.warn("computations created without a root or parent will never be disposed");var u=b(n,l,!1,!1),t=u.node,i=u.value;return null===t?function(){return i}:function(){return t.current()}}var u={time:function(){return a.time}},t=function(){function n(n){this.value=n,this.pending=o,this.log=null}var l=n.prototype;return l.current=function(){return null!==w&&function(n){null===n.log&&(n.log=new r);g(n.log)}(this),this.value},l.next=function(n){if(null!==v)if(this.pending!==o){if(n!==this.pending)throw new Error("conflicting changes: "+n+" !== "+this.pending)}else this.pending=n,a.u.add(this);else null!==this.log?(this.pending=n,a.u.add(this),x()):this.value=n;return n},l.t=function(){return u},n}(),i=function(){function n(){this.i=null,this.value=void 0,this.o=-1,this.state=f,this.s=null,this.h=0,this.v=null,this.p=null,this.log=null,this.m=null,this.g=null}var l=n.prototype;return l.current=function(){if(null!==w){if(this.o===a.time){if(this.state===s)throw new Error("circular dependency");M(this)}!function(n){null===n.log&&(n.log=new r);g(n.log)}(this)}return this.value},l.t=function(){return u},n}(),r=function(){this.j=null,this._=0,this.k=null,this.A=null},e=function(){function n(){this.M=[],this.count=0}var l=n.prototype;return l.reset=function(){this.count=0},l.add=function(n){this.M[this.count++]=n},l.O=function(n){for(var l=this.M,u=0;u<this.count;u++)n(l[u]),l[u]=null;this.count=0},n}(),o={},f=0,c=1,s=2,h=new i,a=new function(){this.time=0,this.u=new e,this.R=new e,this.q=new e},v=null,w=null,d=null,y=null,p={node:null,value:void 0};function b(n,l,u,t){var i=m(),r=d,e=w,o=null===v;d=i,w=t?null:i,l=o?function(n,l){v=a,a.u.reset(),a.R.reset();try{return n(l)}finally{d=w=v=null}}(n,l):n(l),d=r,w=e;var f=E(i,n,l,u);return o&&function(n,l){if(a.u.count>0||a.R.count>0){a.time++;try{j(a)}finally{v=null,d=n,w=l}}}(r,e),p.node=f?null:i,p.value=l,p}function m(){var n=y;return null===n?n=new i:y=null,n}function E(n,l,u,t){var i,r=t||null===d||d===h?null:d,e=null===n.s&&(null===n.m&&null===n.g||null!==r);if(e){if(y=n,null!==r){if(null!==n.m){if(null===r.m)r.m=n.m;else for(i=0;i<n.m.length;i++)r.m.push(n.m[i]);n.m=null}if(null!==n.g){if(null===r.g)r.g=n.g;else for(i=0;i<n.g.length;i++)r.g.push(n.g[i]);n.g=null}}}else n.i=l,n.value=u,n.o=a.time,null!==r&&(null===r.m?r.m=[n]:r.m.push(n));return e}function g(n){var l,u=w,t=null===u.s?-1:null===u.v?0:u.v.length;null===n.j?(n.j=u,n._=t,l=-1):null===n.k?(n.k=[u],n.A=[t],l=0):(l=n.k.length,n.k.push(u),n.A.push(t)),null===u.s?(u.s=n,u.h=l):null===u.v?(u.v=[n],u.p=[l]):(u.v.push(n),u.p.push(l))}function x(){var n=d;a.R.reset(),a.time++;try{j(a)}finally{v=w=null,d=n}}function j(n){var l=v,u=0;for(v=n,n.q.reset();0!==n.u.count||0!==n.R.count||0!==n.q.count;)if(u>0&&n.time++,n.u.O(_),n.R.O(M),n.q.O(q),u++>1e5)throw new Error("Runaway clock detected");v=l}function _(n){n.value=n.pending,n.pending=o,n.log&&k(n.log)}function k(n){var l=n.j,u=n.k;if(null!==l&&A(l),null!==u)for(var t=0,i=u.length;t<i;t++)A(u[t])}function A(n){var l=a.time;n.o<l&&(n.o=l,n.state=c,a.R.add(n),null!==n.m&&function n(l){for(var u=0;u<l.length;u++){var t=l[u];t.o=a.time,t.state=f,null!==t.m&&n(t.m)}}(n.m),null!==n.log&&k(n.log))}function M(n){if(n.state===c){var l=d,u=w;d=w=n,n.state=s,O(n,!1),n.value=n.i(n.value),n.state=f,d=l,w=u}}function O(n,l){var u,t,i=n.s,r=n.v,e=n.p,o=n.g,f=n.m;if(null!==o){for(u=0;u<o.length;u++)o[u](l);n.g=null}if(null!==f){for(u=0;u<f.length;u++)q(f[u]);n.m=null}if(null!==i&&(R(i,n.h),n.s=null),null!==r)for(u=0,t=r.length;u<t;u++)R(r.pop(),e.pop())}function R(n,l){var u,t,i=n.k,r=n.A;-1===l?n.j=null:(u=i.pop(),t=r.pop(),l!==i.length&&(i[l]=u,r[l]=t,-1===t?u.h=l:u.p[t]=l))}function q(n){n.i=null,n.log=null,O(n,!0)}n.B=function(n){null===d?console.warn("cleanups created without a root or parent will never be run"):null===d.g?d.g=[n]:d.g.push(n)},n.data=function(n){var l=new t(n);return function(n){return 0===arguments.length?l.current():l.next(n)}},n.default=l,n.freeze=function(n){var l=void 0;if(null!==v)l=n();else{(v=a).u.reset();try{l=n(),x()}finally{v=null}}return l},n.isFrozen=function(){return null!==v},n.isListening=function(){return null!==w},n.makeComputationNode=b,n.makeDataNode=function(n){return new t(n)},n.on=function(n,u,t,i){var r;return Array.isArray(n)&&(r=n,n=function(){for(var n=0;n<r.length;n++)r[n]()}),i=!!i,l(function(l){var t=w;return n(),i?i=!1:(w=null,l=u(l),w=t),l},t)},n.root=function(n){var l,u=d,t=0===n.length?null:function(){null===i||(null!==v?a.q.add(i):q(i))},i=null===t?h:m();d=i;try{l=null===t?n():n(t)}finally{d=u}return null!==t&&E(i,null,void 0,!0)&&(i=null),l},n.sample=function(n){var l,u=w;return w=null,l=n(),w=u,l},n.value=function(n,l){var u=new t(n),i=-1;return function(t){if(0===arguments.length)return u.current();if(!(l?l(n,t):n===t)){var r=a.time;if(i===r)throw new Error("conflicting values: "+t+" is not the same as "+n);i=r,n=t,u.next(t)}return t}},Object.defineProperty(n,"C",{value:!0})});
