!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(n=n||self).S=e()}(this,function(){"use strict";var n=function(n,e){var t=k,u=null===d?f:d,s=h;null===t&&console.warn("computations created without a root or parent will never be disposed");var c=new l(u,n,e);return k=h=c,null===d?function(n){d=f,f.changes.reset(),f.subclocks.reset(),f.updates.reset();try{n.value=n.fn(n.value),(f.changes.count>0||f.subclocks.count>0||f.updates.count>0)&&(f.subtime++,b(f))}finally{d=k=h=null}}(c):c.value=c.fn(c.value),t&&t!==g&&(null===t.owned?t.owned=[c]:t.owned.push(c)),k=t,h=s,function(){if(null!==h){for(var n=d,e=c.clock;n.depth>e.depth+1;)n=n.parent;if(n===e||n.parent===e){if(null!==c.preclocks)for(var t=0;t<c.preclocks.count;t++){z(l=c.preclocks.clocks[t])}if(c.age===c.clock.time()){if(c.state===p)throw new Error("circular dependency");O(c)}if(null!==c.preclocks)for(t=0;t<c.preclocks.count;t++){var l=c.preclocks.clocks[t];n===e?w(l,h):m(l,n,h)}}else{for(n.depth>e.depth&&(n=n.parent);e.depth>n.depth+1;)e=e.parent;if(e.parent===n)w(e,h);else{for(e.depth>n.depth&&(e=e.parent);n.parent!==e.parent;)n=n.parent,e=e.parent;m(e,n,h)}z(e)}!function(n,e){null===n.log&&(n.log=new o);v(n.log,e)}(c,h)}return c.value}};Object.defineProperty(n,"default",{value:n}),n.root=function(n){var e=k,t=0===n.length?g:new l(d||f,null,null),o=void 0,u=0===n.length?null:function(){null!==d?(A(t.clock),t.clock.disposes.add(t)):S(t)};return k=t,null===d?o=function(n,e,t){try{return null===e?n():n(e)}finally{k=t}}(n,u,e):(o=null===u?n():n(u),k=e),o},n.on=function(e,t,l,o){var u;return Array.isArray(e)&&(u=e,e=function(){for(var n=0;n<u.length;n++)u[n]()}),o=!!o,n(s,l);function s(n){var l=h;return e(),o?o=!1:(h=null,n=t(n),h=l),n}},n.data=function(n){var e=new t(null===d?f:d,n);return function(n){var t=d,l=e.clock;if(null!==d){for(;t.depth>l.depth;)t=t.parent;for(;l.depth>t.depth&&l.parent!==t;)l=l.parent;if(l.parent!==t)for(;t.parent!==l.parent;)t=t.parent,l=l.parent;t!==l&&z(l)}var u=t===l?l:l.parent;if(arguments.length>0){if(null!==d)if(e.pending!==r){if(n!==e.pending)throw new Error("conflicting changes: "+n+" !== "+e.pending)}else A(u),e.pending=n,u.changes.add(e);else null!==e.log?(e.pending=n,f.changes.add(e),y()):e.value=n;return n}return null!==h&&(!function(n,e){null===n.log&&(n.log=new o);v(n.log,e)}(e,h),l.parent===t?w(l,h):l!==t&&m(l,t,h)),e.value}},n.value=function(e,t){var l=n.data(e),o=d||f,u=-1;return function(n){if(0===arguments.length)return l();if(!(t?t(e,n):e===n)){var s=o.time();if(u===s)throw new Error("conflicting values: "+n+" is not the same as "+e);u=s,e=n,l(n)}return n}},n.freeze=function(n){var e=void 0;if(null!==d)e=n();else{(d=f).changes.reset();try{e=n(),y()}finally{d=null}}return e},n.sample=function(n){var e,t=h;return null!==t?(h=null,e=n(),h=t):e=n(),e},n.cleanup=function(n){null!==k?null===k.cleanups?k.cleanups=[n]:k.cleanups.push(n):console.warn("cleanups created without a root or parent will never be run")},n.subclock=function(n){var t=new e(d||f);return void 0===n?l:l(n);function l(n){var e=null,l=d;d=t,t.state=a;try{e=n(),t.subtime++,b(t)}finally{d=l}return null===d&&y(),e}};var e=function(){function n(e){this.parent=e,this.id=n.count++,this.state=i,this.subtime=0,this.preclocks=null,this.changes=new c,this.subclocks=new c,this.updates=new c,this.disposes=new c,null!==e?(this.age=e.time(),this.depth=e.depth+1):(this.age=0,this.depth=0)}return n.prototype.time=function(){for(var n=this.subtime,e=this;null!==(e=e.parent);)n+=e.subtime;return n},n.count=0,n}(),t=function(){return function(n,e){this.clock=n,this.value=e,this.pending=r,this.log=null}}(),l=function(){return function(n,e,t){this.clock=n,this.fn=e,this.value=t,this.state=i,this.source1=null,this.source1slot=0,this.sources=null,this.sourceslots=null,this.log=null,this.preclocks=null,this.owned=null,this.cleanups=null,this.age=this.clock.time()}}(),o=function(){return function(){this.node1=null,this.node1slot=0,this.nodes=null,this.nodeslots=null}}(),u=function(){return function(){this.count=0,this.clocks=[],this.ages=[],this.ucount=0,this.uclocks=[],this.uclockids=[]}}(),s=function(){return function(){this.count=0,this.clockcounts=[],this.clocks=[],this.ids=[]}}(),c=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var e=this.items,t=0;t<this.count;t++)n(e[t]),e[t]=null;this.count=0},n}(),r={},i=0,a=1,p=2,f=new e(null),d=null,h=null,k=null,g=new l(f,null,null);function v(n,e){var t,l=null===e.source1?-1:null===e.sources?0:e.sources.length;null===n.node1?(n.node1=e,n.node1slot=l,t=-1):null===n.nodes?(n.nodes=[e],n.nodeslots=[l],t=0):(t=n.nodes.length,n.nodes.push(e),n.nodeslots.push(l)),null===e.source1?(e.source1=n,e.source1slot=t):null===e.sources?(e.sources=[n],e.sourceslots=[t]):(e.sources.push(n),e.sourceslots.push(t))}function w(n,e){if(null===e.preclocks)e.preclocks=new u;else if(e.preclocks.ages[n.id]===e.age)return;e.preclocks.ages[n.id]=e.age,e.preclocks.clocks[e.preclocks.count++]=n}function m(n,e,t){var l=null===e.preclocks?e.preclocks=new s:e.preclocks,o=null===t.preclocks?t.preclocks=new u:t.preclocks;if(o.ages[n.id]!==t.age){o.ages[n.id]=t.age,o.uclocks[o.ucount]=e,o.uclockids[o.ucount++]=n.id;var c=l.clockcounts[n.id];void 0===c?(l.ids[l.count++]=n.id,l.clockcounts[n.id]=1,l.clocks[n.id]=n):0===c?(l.clockcounts[n.id]=1,l.clocks[n.id]=n):l.clockcounts[n.id]++}}function y(){var n=k;f.subclocks.reset(),f.updates.reset(),f.subtime++;try{b(f)}finally{d=h=null,k=n}}function b(n){var e=d,t=0;for(d=n,n.disposes.reset();0!==n.changes.count||0!==n.subclocks.count||0!==n.updates.count||0!==n.disposes.count;)if(t>0&&n.subtime++,n.changes.run(E),n.subclocks.run(z),n.updates.run(O),n.disposes.run(S),t++>1e5)throw new Error("Runaway clock detected");d=e}function E(n){n.value=n.pending,n.pending=r,n.log&&j(n.log)}function j(n){var e=n.node1,t=n.nodes;if(null!==e&&x(e),null!==t)for(var l=0,o=t.length;l<o;l++)x(t[l])}function x(n){var e=n.clock.time();n.age<e&&(A(n.clock),n.age=e,n.state=a,n.clock.updates.add(n),null!==n.owned&&function n(e){for(var t=0;t<e.length;t++){var l=e[t];l.age=l.clock.time(),l.state=i,null!==l.owned&&n(l.owned)}}(n.owned),null!==n.log&&j(n.log))}function A(n){var e=0;(null!==n.parent&&n.age<(e=n.parent.time())||n.state===i)&&(null!==n.parent&&(n.age=e,A(n.parent),n.parent.subclocks.add(n)),n.changes.reset(),n.subclocks.reset(),n.updates.reset(),n.state=a)}function z(n){var e=n.parent.time();if(n.age<e||n.state===a){if(n.age<e&&(n.state=i),null!==n.preclocks)for(var t=0;t<n.preclocks.ids.length;t++){var l=n.preclocks.clocks[n.preclocks.ids[t]];l&&z(l)}n.age=e}if(n.state===p)throw new Error("clock circular reference");n.state===a&&(n.state=p,b(n),n.state=i)}function O(n){if(n.state===a){var e=k,t=h,l=d;k=h=n,d=n.clock,n.state=p,P(n,!1),n.value=n.fn(n.value),n.state=i,k=e,h=t,d=l}}function P(n,e){var t,l,o=n.source1,u=n.sources,s=n.sourceslots,c=n.cleanups,r=n.owned,i=n.preclocks;if(null!==c){for(t=0;t<c.length;t++)c[t](e);n.cleanups=null}if(null!==r){for(t=0;t<r.length;t++)S(r[t]);n.owned=null}if(null!==o&&(R(o,n.source1slot),n.source1=null),null!==u)for(t=0,l=u.length;t<l;t++)R(u.pop(),s.pop());if(null!==i){for(t=0;t<i.count;t++)i.clocks[t]=null;for(i.count=0,t=0;t<i.ucount;t++){var a=i.uclocks[t].preclocks,p=i.uclockids[t];0==--a.clockcounts[p]&&(a.clocks[p]=null)}i.ucount=0}}function R(n,e){var t,l,o=n.nodes,u=n.nodeslots;-1===e?n.node1=null:(t=o.pop(),l=u.pop(),e!==o.length&&(o[e]=t,u[e]=l,-1===l?t.source1slot=e:t.sourceslots[l]=e))}function S(n){n.clock=null,n.fn=null,n.log=null,n.preclocks=null,P(n,!0)}return n});
